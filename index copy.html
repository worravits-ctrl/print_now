<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Card Printer - ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            display: flex;
            gap: 30px;
            padding: 30px;
        }

        .controls {
            flex: 1;
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #e1e8ff;
        }

        .preview {
            flex: 2;
            background: white;
            border-radius: 15px;
            border: 2px solid #e1e8ff;
            padding: 20px;
        }

        .control-group {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-left: 4px solid #4ECDC4;
        }

        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .control-group h3::before {
            content: "üéõÔ∏è";
            margin-right: 8px;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-upload input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
        }

        .file-upload-btn {
            display: block;
            padding: 15px 25px;
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .file-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-group label {
            display: block;
            margin-bottom: 8px;
            color: #34495e;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            transition: background 0.3s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ECDC4;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ECDC4;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .value-display {
            display: inline-block;
            margin-left: 10px;
            font-weight: bold;
            color: #4ECDC4;
            background: #f0f8ff;
            padding: 4px 8px;
            border-radius: 6px;
            min-width: 50px;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-print {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-pdf {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
            box-shadow: 0 4px 15px rgba(240, 147, 251, 0.4);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .a4-preview {
            width: 100%;
            max-width: 900px;
            height: 900px;
            background: white;
            border: 2px solid #ddd;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .card-container {
            position: absolute;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(5, 1fr);
            width: 100%;
            height: 100%;
        }

        .business-card {
            width: 100mm;
            height: 54mm;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .business-card:hover {
            border-color: #4ECDC4;
            box-shadow: 0 2px 8px rgba(78, 205, 196, 0.3);
        }

        .business-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .card-placeholder {
            color: #999;
            text-align: center;
            font-size: 0.8rem;
            padding: 10px;
            line-height: 1.4;
        }

        .image-preview {
            max-width: 100%;
            max-height: 150px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
            text-align: center;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .units {
            font-size: 0.8rem;
            color: #666;
            font-weight: normal;
        }

        .job-management {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e1e8ff;
        }

        .job-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: #2d5016;
            border-left: 4px solid #4CAF50;
        }

        .supabase-config {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e1e8ff;
        }

        .connection-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .storage-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #2d5016;
            border-left: 4px solid #4CAF50;
        }

        .storage-info.cloud {
            background: #e3f2fd;
            color: #0d47a1;
            border-left-color: #2196F3;
        }

        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .header, .controls { display: none; }
            .content { padding: 0; }
            .preview { border: none; background: white; }
            .a4-preview { 
                width: 210mm;
                height: 297mm;
                max-width: none;
                border: none;
                box-shadow: none;
            }
            .preview h3 { display: none !important; }
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
                gap: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .a4-preview {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñ®Ô∏è Business Card Printer</h1>
            <p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ - ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
        </div>
        
        <div class="content">
            <div class="controls">
                <div class="control-group">
                    <h3>üåê ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase</h3>
                    <div class="supabase-config">
                        <input type="text" id="supabaseUrl" placeholder="Supabase Project URL" 
                               style="width: 100%; padding: 10px; margin-bottom: 8px; border: 2px solid #e1e8ff; border-radius: 6px; font-size: 0.9rem;">
                        <input type="password" id="supabaseKey" placeholder="Supabase Anon Key" 
                               style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #e1e8ff; border-radius: 6px; font-size: 0.9rem;">
                        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                            <button class="btn" id="connectSupabaseBtn" style="flex: 1; background: linear-gradient(45deg, #3ECF8E, #2DD4BF); color: white; font-size: 0.85rem; padding: 8px;">
                                üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
                            </button>
                            <button class="btn" id="testConnectionBtn" style="flex: 1; background: linear-gradient(45deg, #8B5CF6, #A855F7); color: white; font-size: 0.85rem; padding: 8px;" disabled>
                                üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                            </button>
                        </div>
                        <div id="connectionStatus" class="connection-status"></div>
                        <div style="font-size: 0.8rem; color: #666; line-height: 1.4;">
                            üí° <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤:</strong><br>
                            1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ <a href="https://supabase.com" target="_blank">Supabase.com</a><br>
                            2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á <code>print_jobs</code><br>
                            3. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡πÅ‡∏•‡∏∞ API Key ‡∏°‡∏≤‡πÉ‡∏™‡πà
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üíæ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå</h3>
                    <div class="job-management">
                        <input type="text" id="jobName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC)" 
                               style="width: 100%; padding: 12px; margin-bottom: 10px; border: 2px solid #e1e8ff; border-radius: 8px; font-size: 1rem;">
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="btn" id="saveJobBtn" style="flex: 1; background: linear-gradient(45deg, #4ECDC4, #44A08D); color: white; font-size: 0.9rem; padding: 10px;">
                                üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
                            </button>
                            <select id="savedJobs" style="flex: 2; padding: 10px; border: 2px solid #e1e8ff; border-radius: 8px; font-size: 0.9rem;">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ...</option>
                            </select>
                            <button class="btn" id="loadJobBtn" style="flex: 1; background: linear-gradient(45deg, #FFA726, #FF7043); color: white; font-size: 0.9rem; padding: 10px;">
                                üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô
                            </button>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                            <button class="btn" id="syncJobsBtn" style="flex: 1; background: linear-gradient(45deg, #2196F3, #03DAC6); color: white; font-size: 0.85rem; padding: 8px;" disabled>
                                üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
                            </button>
                            <button class="btn" id="deleteJobBtn" style="flex: 1; background: linear-gradient(45deg, #FF5722, #E91E63); color: white; font-size: 0.85rem; padding: 8px;">
                                üóëÔ∏è ‡∏•‡∏ö‡∏á‡∏≤‡∏ô
                            </button>
                        </div>
                        <div id="storageInfo" class="storage-info"></div>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£</h3>
                    <div class="file-upload">
                        <input type="file" id="imageFile" accept="image/*">
                        <div class="file-upload-btn">
                            üì§ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û (JPG, PNG, GIF)
                        </div>
                    </div>
                    <div id="imagePreview"></div>
                </div>

                <div class="control-group">
                    <h3>üìç ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
                    <div class="slider-group">
                        <label>‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤ <span class="units">(Left-Right)</span></label>
                        <input type="range" class="slider" id="offsetX" min="-20" max="20" value="0">
                        <span class="value-display" id="offsetX-value">0</span> <span class="units">mm</span>
                    </div>
                    <div class="slider-group">
                        <label>‡∏ö‡∏ô-‡∏•‡πà‡∏≤‡∏á <span class="units">(Top-Bottom)</span></label>
                        <input type="range" class="slider" id="offsetY" min="-20" max="20" value="0">
                        <span class="value-display" id="offsetY-value">0</span> <span class="units">mm</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üìê ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πå‡∏î</h3>
                    <div class="slider-group">
                        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á <span class="units">(Width)</span></label>
                        <input type="range" class="slider" id="cardWidth" min="50" max="120" value="90">
                        <span class="value-display" id="cardWidth-value">90</span> <span class="units">mm</span>
                    </div>
                    <div class="slider-group">
                        <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á <span class="units">(Height)</span></label>
                        <input type="range" class="slider" id="cardHeight" min="30" max="80" value="54">
                        <span class="value-display" id="cardHeight-value">54</span> <span class="units">mm</span>
                    </div>
                </div>

                <div class="control-group">
                    <h3>üìè ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á</h3>
                    <div class="slider-group">
                        <label>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå <span class="units">(Column Gap)</span></label>
                        <input type="range" class="slider" id="gapX" min="0" max="20" value="5">
                        <span class="value-display" id="gapX-value">5</span> <span class="units">mm</span>
                    </div>
                    <div class="slider-group">
                        <label>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß <span class="units">(Row Gap)</span></label>
                        <input type="range" class="slider" id="gapY" min="0" max="20" value="5">
                        <span class="value-display" id="gapY-value">5</span> <span class="units">mm</span>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-print" id="printBtn" disabled>
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
                    </button>
                    <button class="btn btn-pdf" id="pdfBtn" disabled>
                        üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
                    </button>
                </div>

                <div id="statusMessage"></div>
            </div>

            <div class="preview">
                <!-- ‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ preview -->
                <div class="a4-preview">
                    <div class="card-container" id="cardContainer">
                        <!-- Cards will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedImage = null;
        let imageDataURL = null;

        // DOM elements
        const imageFile = document.getElementById('imageFile');
        const imagePreview = document.getElementById('imagePreview');
        const cardContainer = document.getElementById('cardContainer');
        const printBtn = document.getElementById('printBtn');
        const pdfBtn = document.getElementById('pdfBtn');
        const statusMessage = document.getElementById('statusMessage');

        // Job management elements
        const jobName = document.getElementById('jobName');
        const saveJobBtn = document.getElementById('saveJobBtn');
        const savedJobs = document.getElementById('savedJobs');
        const loadJobBtn = document.getElementById('loadJobBtn');
        const deleteJobBtn = document.getElementById('deleteJobBtn');
        const syncJobsBtn = document.getElementById('syncJobsBtn');

        // Supabase elements
        const supabaseUrl = document.getElementById('supabaseUrl');
        const supabaseKey = document.getElementById('supabaseKey');
        const connectSupabaseBtn = document.getElementById('connectSupabaseBtn');
        const testConnectionBtn = document.getElementById('testConnectionBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const storageInfo = document.getElementById('storageInfo');

        // Sliders
        const offsetX = document.getElementById('offsetX');
        const offsetY = document.getElementById('offsetY');
        const gapX = document.getElementById('gapX');
        const gapY = document.getElementById('gapY');
        const cardWidth = document.getElementById('cardWidth');
        const cardHeight = document.getElementById('cardHeight');

        // Supabase client
        let supabase = null;
        let isConnected = false;
        let savedJobsData = {};

        // Initialize cards
        function createCards() {
            cardContainer.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const card = document.createElement('div');
                card.className = 'business-card';
                const placeholder = document.createElement('div');
                placeholder.className = 'card-placeholder';
                placeholder.innerHTML = 'üìá<br>‡∏ô‡∏≤‡∏°‡∏ö‡∏±‡∏ï‡∏£ ' + (i + 1) + '<br>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á';
                card.appendChild(placeholder);
                cardContainer.appendChild(card);
            }
        }

        // Update card positions and spacing
        function updateLayout() {
            const offsetXVal = parseInt(offsetX.value);
            const offsetYVal = parseInt(offsetY.value);
            const gapXVal = parseInt(gapX.value);
            const gapYVal = parseInt(gapY.value);
            const cardWidthVal = parseInt(cardWidth.value);
            const cardHeightVal = parseInt(cardHeight.value);

            // Update value displays
            document.getElementById('offsetX-value').textContent = offsetXVal;
            document.getElementById('offsetY-value').textContent = offsetYVal;
            document.getElementById('gapX-value').textContent = gapXVal;
            document.getElementById('gapY-value').textContent = gapYVal;
            document.getElementById('cardWidth-value').textContent = cardWidthVal;
            document.getElementById('cardHeight-value').textContent = cardHeightVal;

            // Calculate positions (convert mm to pixels for display)
            const mmToPx = 3.779527559; // 1mm = 3.78px at 96dpi
            const cardWidthPx = cardWidthVal * mmToPx;
            const cardHeightPx = cardHeightVal * mmToPx;
            
            const cards = cardContainer.querySelectorAll('.business-card');
            cards.forEach((card, index) => {
                const row = Math.floor(index / 2);
                const col = index % 2;
                
                const x = (offsetXVal * mmToPx) + (col * (cardWidthPx + gapXVal * mmToPx));
                const y = (offsetYVal * mmToPx) + (row * (cardHeightPx + gapYVal * mmToPx));
                
                card.style.left = x + 'px';
                card.style.top = y + 'px';
                card.style.width = cardWidthPx + 'px';
                card.style.height = cardHeightPx + 'px';
                card.style.position = 'absolute';
            });
        }

        // Update cards with selected image
        function updateCardsWithImage() {
            if (!imageDataURL) return;
            
            const cards = cardContainer.querySelectorAll('.business-card');
            cards.forEach(card => {
                const img = document.createElement('img');
                img.src = imageDataURL;
                img.alt = 'Business Card';
                card.innerHTML = '';
                card.appendChild(img);
            });
        }

        // Show status message
        function showStatus(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'status-message status-' + type;
            messageDiv.textContent = message;
            statusMessage.innerHTML = '';
            statusMessage.appendChild(messageDiv);
            
            setTimeout(() => {
                statusMessage.innerHTML = '';
            }, 3000);
        }

        // Supabase Functions
        async function connectToSupabase() {
        const url = supabaseUrl.value.trim();
        const key = supabaseKey.value.trim();

        if (!url || !key) {
            showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡πÅ‡∏•‡∏∞ API Key', 'error');
            return;
        }

        try {
            showConnectionStatus('connecting', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
            console.log('Connecting to Supabase with URL:', url);
            supabase = window.supabase.createClient(url, key);

            // Test connection
            const { data, error } = await supabase
                .from('print_jobs')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Supabase connection error:', error);
                showConnectionStatus('disconnected', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
                showStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
                return;
            }

            // Merge with local data
            data.forEach(job => {
                savedJobsData[job.name] = {
                    name: job.name,
                    imageDataURL: job.image_data,
                    imageName: job.image_name,
                    imageSize: job.image_size || 0,
                    settings: job.settings,
                    timestamp: new Date(job.created_at).toLocaleString('th-TH'),
                    id: job.id,
                    source: 'supabase'
                };
            });

            loadSavedJobsList();
            updateStorageInfo();
            showConnectionStatus('connected', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            showStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (' + data.length + ' ‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Supabase)', 'success');
            isConnected = true;
            // Save credentials to localStorage
            try {
                localStorage.setItem('supabaseUrl', url);
                localStorage.setItem('supabaseKey', key);
            } catch (e) {
                console.log('Cannot save Supabase credentials to localStorage:', e);
            }
            // Enable test and sync buttons
            testConnectionBtn.disabled = false;
            syncJobsBtn.disabled = false;

        } catch (error) {
            console.error('Sync error (catch):', error);
            showConnectionStatus('disconnected', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message);
            showStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
        }
        }

        async function saveToSupabase(jobData) {
            if (!isConnected || !supabase) {
                showStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase', 'error');
                return false;
            }
            try {
                const { data, error } = await supabase
                    .from('print_jobs')
                    .upsert({
                        name: jobData.name,
                        image_data: jobData.imageDataURL,
                        image_name: jobData.imageName,
                        image_size: jobData.imageSize,
                        settings: jobData.settings,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'name'
                    })
                    .select();
                console.log('saveToSupabase result:', { data, error });
                if (error) {
                    showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (error.message || JSON.stringify(error)), 'error');
                    console.error('saveToSupabase error object:', error);
                    alert('saveToSupabase error: ' + JSON.stringify(error));
                    return false;
                }
                if (!data) {
                    showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö', 'error');
                    console.error('saveToSupabase: No data returned', { data, error });
                    alert('saveToSupabase: No data returned: ' + JSON.stringify({ data, error }));
                    return false;
                }
                showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supabase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                return true;
            } catch (error) {
                console.error('Save to Supabase error (catch):', error);
                showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå Supabase: ' + (error.message || JSON.stringify(error)), 'error');
                alert('Save to Supabase error (catch): ' + JSON.stringify(error));
                return false;
            }
        }

        async function deleteFromSupabase(jobName) {
            if (!isConnected || !supabase) return false;

            try {
                const { error } = await supabase
                    .from('print_jobs')
                    .delete()
                    .eq('name', jobName);

                if (error) throw error;

                console.log('Deleted from Supabase:', jobName);
                return true;

            } catch (error) {
                console.error('Delete from Supabase error:', error);
                return false;
            }
        }

        function updateStorageInfo() {
            const localJobs = Object.keys(savedJobsData).filter(key => savedJobsData[key].source !== 'supabase').length;
            const cloudJobs = Object.keys(savedJobsData).filter(key => savedJobsData[key].source === 'supabase').length;
            const totalJobs = Object.keys(savedJobsData).length;

            if (isConnected) {
                storageInfo.className = 'storage-info cloud';
                storageInfo.innerHTML = 'Online Storage: ' + cloudJobs + ' ‡∏á‡∏≤‡∏ô<br>Local Storage: ' + localJobs + ' ‡∏á‡∏≤‡∏ô<br>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + totalJobs + ' ‡∏á‡∏≤‡∏ô';
            } else {
                storageInfo.className = 'storage-info';
                storageInfo.innerHTML = 'Local Storage: ' + totalJobs + ' ‡∏á‡∏≤‡∏ô<br>‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase';
            }
        }

        async function saveJob() {
        const name = jobName.value.trim();
        if (!name) {
            showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå', 'error');
            return;
        }

        if (!selectedImage || !imageDataURL) {
            showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô', 'error');
            return;
        }

        const jobData = {
            name: name,
            imageDataURL: imageDataURL,
            imageName: selectedImage.name,
            imageSize: selectedImage.size || 0,
            settings: {
                offsetX: parseInt(offsetX.value),
                offsetY: parseInt(offsetY.value),
                gapX: parseInt(gapX.value),
                gapY: parseInt(gapY.value),
                cardWidth: parseInt(cardWidth.value),
                cardHeight: parseInt(cardHeight.value)
            },
            timestamp: new Date().toLocaleString('th-TH', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }),
            source: 'local'
        };

        // Save locally first
        savedJobsData[name] = jobData;

        // Try to save to localStorage
        try {
            if (typeof Storage !== "undefined") {
                const localData = {};
                Object.entries(savedJobsData).forEach(([key, value]) => {
                    if (value.source === 'local') {
                        localData[key] = value;
                    }
                });
                localStorage.setItem('businessCardJobs', JSON.stringify(localData));
            }
        } catch (e) {
            console.log('localStorage save failed:', e);
        }

        showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase...', 'success');
        console.log('saveJob: calling saveToSupabase', jobData);
        // Try to save to Supabase
        try {
            const supabaseSaved = await saveToSupabase(jobData);
            console.log('saveJob: saveToSupabase returned', supabaseSaved);
            if (supabaseSaved) {
                jobData.source = 'supabase';
                savedJobsData[name] = jobData;
            }
            loadSavedJobsList();
            updateStorageInfo();
            const storageText = supabaseSaved ? '(‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)' : '(‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô)';
            showStatus('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô "' + name + '" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ' + storageText, 'success');
            jobName.value = '';
        } catch (e) {
            console.error('saveJob error (catch):', e);
            showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô: ' + (e.message || JSON.stringify(e)), 'error');
            alert('saveJob error (catch): ' + JSON.stringify(e));
        }
        }

        function loadSavedJobsList() {
            savedJobs.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ...</option>';
            
            // Load from localStorage first (local jobs only)
            try {
                if (typeof Storage !== "undefined") {
                    const stored = localStorage.getItem('businessCardJobs');
                    if (stored) {
                        const storedData = JSON.parse(stored);
                        Object.entries(storedData).forEach(([key, job]) => {
                            if (!savedJobsData[key]) {
                                savedJobsData[key] = job;
                                savedJobsData[key].source = 'local';
                            }
                        });
                    }
                }
            } catch (e) {
                console.log('Could not load from localStorage:', e);
            }
            
            // Populate dropdown
            const jobKeys = Object.keys(savedJobsData);
            if (jobKeys.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ";
                option.disabled = true;
                savedJobs.appendChild(option);
                return;
            }

            // Sort jobs by timestamp (newest first)
            const sortedJobs = jobKeys.sort((a, b) => {
                const dateA = new Date(savedJobsData[a].timestamp);
                const dateB = new Date(savedJobsData[b].timestamp);
                return dateB - dateA;
            });

            sortedJobs.forEach(jobKey => {
                const job = savedJobsData[jobKey];
                const option = document.createElement('option');
                option.value = jobKey;
                const sizeText = job.imageSize ? ' - ' + (job.imageSize/1024).toFixed(1) + 'KB' : '';
                const sourceIcon = job.source === 'supabase' ? 'üåê' : 'üíæ';
                option.textContent = sourceIcon + ' ' + job.name + ' (' + job.timestamp + ')' + sizeText;
                savedJobs.appendChild(option);
            });
            
            updateStorageInfo();
            console.log('Loaded ' + jobKeys.length + ' saved jobs');
        }

        function loadJob() {
            const selectedJobKey = savedJobs.value;
            if (!selectedJobKey || selectedJobKey === "") {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î', 'error');
                return;
            }

            const jobData = savedJobsData[selectedJobKey];
            if (!jobData) {
                showStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å', 'error');
                return;
            }

            try {
                // Load image data
                imageDataURL = jobData.imageDataURL;
                selectedImage = { 
                    name: jobData.imageName,
                    size: jobData.imageSize || 0
                };
                
                // Load settings
                offsetX.value = jobData.settings.offsetX || 0;
                offsetY.value = jobData.settings.offsetY || 0;
                gapX.value = jobData.settings.gapX || 5;
                gapY.value = jobData.settings.gapY || 5;
                cardWidth.value = jobData.settings.cardWidth || 90;
                cardHeight.value = jobData.settings.cardHeight || 54;
                
                // Update preview
                const sizeText = jobData.imageSize ? ' (' + (jobData.imageSize/1024).toFixed(1) + ' KB)' : '';
                const sourceIcon = jobData.source === 'supabase' ? 'üåê' : 'üíæ';
                
                const previewHTML = '<img src="' + imageDataURL + '" class="image-preview" alt="Preview">' +
                    '<div class="job-info">' +
                    sourceIcon + ' ' + jobData.imageName + sizeText + '<br>' +
                    'üìÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + jobData.timestamp + '<br>' +
                    'üéõÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (' + jobData.settings.offsetX + ', ' + jobData.settings.offsetY + ') ‡∏Ç‡∏ô‡∏≤‡∏î ' + jobData.settings.cardWidth + '√ó' + jobData.settings.cardHeight + 'mm' +
                    '</div>';
                
                imagePreview.innerHTML = previewHTML;
                
                // Update cards and layout
                updateCardsWithImage();
                updateLayout();
                
                // Enable buttons
                printBtn.disabled = false;
                pdfBtn.disabled = false;
                
                const sourceText = jobData.source === 'supabase' ? '(‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)' : '(‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô)';
                showStatus('‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô "' + jobData.name + '" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ' + sourceText, 'success');
                
            } catch (e) {
                console.error('Error loading job:', e);
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏á‡∏≤‡∏ô', 'error');
            }
        }

        async function deleteJob() {
            const selectedJobKey = savedJobs.value;
            if (!selectedJobKey || selectedJobKey === "") {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }

            const jobData = savedJobsData[selectedJobKey];
            if (!jobData) {
                showStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö', 'error');
                return;
            }

            const sourceText = jobData.source === 'supabase' ? '(‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)' : '(‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô)';
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô "' + jobData.name + '" ' + sourceText + ' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠: ' + jobData.timestamp)) {
                try {
                    // Delete from Supabase if it's a cloud job
                    if (jobData.source === 'supabase') {
                        await deleteFromSupabase(selectedJobKey);
                    }
                    
                    // Delete from memory
                    delete savedJobsData[selectedJobKey];
                    
                    // Update localStorage (local jobs only)
                    try {
                        if (typeof Storage !== "undefined") {
                            const localJobs = {};
                            Object.entries(savedJobsData).forEach(([key, value]) => {
                                if (value.source === 'local') {
                                    localJobs[key] = value;
                                }
                            });
                            localStorage.setItem('businessCardJobs', JSON.stringify(localJobs));
                        }
                    } catch (e) {
                        console.log('Could not update localStorage:', e);
                    }
                    
                    loadSavedJobsList();
                    showStatus('‡∏•‡∏ö‡∏á‡∏≤‡∏ô "' + jobData.name + '" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ' + Object.keys(savedJobsData).length + ' ‡∏á‡∏≤‡∏ô)', 'success');
                    
                    // Reset selection
                    savedJobs.value = "";
                    
                } catch (e) {
                    console.error('Error deleting job:', e);
                    showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏á‡∏≤‡∏ô', 'error');
                }
            }
        }

        // Handle image selection
        imageFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û (JPG, PNG, GIF)', 'error');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                showStatus('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ( ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10MB)', 'error');
                return;
            }

            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û...', 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                imageDataURL = e.target.result;
                selectedImage = {
                    name: file.name,
                    size: file.size,
                    type: file.type
                };
                
                // Show image preview
                const previewHTML = '<img src="' + imageDataURL + '" class="image-preview" alt="Preview">' +
                    '<p style="color: #666; font-size: 0.9rem; margin-top: 8px;">' +
                    'üìÅ ' + file.name + ' (' + (file.size/1024).toFixed(1) + ' KB)' +
                    '</p>';
                
                imagePreview.innerHTML = previewHTML;
                
                // Update all cards with the image
                updateCardsWithImage();
                
                // Enable buttons
                printBtn.disabled = false;
                pdfBtn.disabled = false;
                
                showStatus('‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå', 'success');
            };
            
            reader.onerror = function() {
                showStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
            };
            
            reader.readAsDataURL(file);
        });

        // Print function
        printBtn.addEventListener('click', function() {
            if (!selectedImage) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå', 'error');
                return;
            }
            
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå...', 'success');
            setTimeout(() => {
                window.print();
            }, 500);
        });

        // PDF generation
        pdfBtn.addEventListener('click', async function() {
            if (!selectedImage) {
                showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á PDF', 'error');
                return;
            }

            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...', 'success');

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // A4 size: 210 x 297 mm
                const offsetXVal = parseInt(offsetX.value);
                const offsetYVal = parseInt(offsetY.value);
                const gapXVal = parseInt(gapX.value);
                const gapYVal = parseInt(gapY.value);
                const cardWidthVal = parseInt(cardWidth.value);
                const cardHeightVal = parseInt(cardHeight.value);
                
                // Add 10 cards (2 columns, 5 rows)
                for (let i = 0; i < 10; i++) {
                    const row = Math.floor(i / 2);
                    const col = i % 2;
                    
                    const x = offsetXVal + (col * (cardWidthVal + gapXVal));
                    const y = offsetYVal + (row * (cardHeightVal + gapYVal));
                    
                    // Add image to PDF
                    pdf.addImage(imageDataURL, 'JPEG', x, y, cardWidthVal, cardHeightVal);
                }
                
                // Save PDF
                const fileName = selectedImage.name.split('.')[0] + '_business_cards.pdf';
                pdf.save(fileName);
                
                showStatus('‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (error) {
                console.error('PDF generation error:', error);
                showStatus('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF', 'error');
            }
        });

        // Event listeners for sliders
        [offsetX, offsetY, gapX, gapY, cardWidth, cardHeight].forEach(slider => {
            slider.addEventListener('input', updateLayout);
        });

        // Job management event listeners
        saveJobBtn.addEventListener('click', saveJob);
        loadJobBtn.addEventListener('click', loadJob);
        deleteJobBtn.addEventListener('click', deleteJob);
        connectSupabaseBtn.addEventListener('click', connectToSupabase);
        testConnectionBtn.addEventListener('click', testConnection);
        syncJobsBtn.addEventListener('click', syncFromSupabase);

        // Auto-load saved Supabase credentials
        function loadSavedCredentials() {
            try {
                const savedUrl = localStorage.getItem('supabaseUrl');
                const savedKey = localStorage.getItem('supabaseKey');
                
                if (savedUrl) supabaseUrl.value = savedUrl;
                if (savedKey) supabaseKey.value = savedKey;
                
                if (savedUrl && savedKey) {
                    showConnectionStatus('disconnected', '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡∏Å‡∏î ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠)');
                }
            } catch (e) {
                console.log('Could not load saved credentials:', e);
            }
        }

        // Initialize
        createCards();
        updateLayout();
        loadSavedCredentials();
        loadSavedJobsList();
        
        // Welcome message
        showStatus('‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå', 'success');
        
        // Debug info
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase
    function showConnectionStatus(type, message) {
        connectionStatus.className = 'connection-status ' + type;
        connectionStatus.textContent = message;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase
    async function testConnection() {
        if (!supabase) {
            showStatus('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase ‡∏Å‡πà‡∏≠‡∏ô', 'error');
            return;
        }
        try {
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', 'success');
            const { data, error } = await supabase
                .from('print_jobs')
                .select('id')
                .limit(1);
            console.log('testConnection result:', { data, error });
            if (error) {
                showStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
            } else {
                showStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏û‡∏ö ' + (data ? data.length : 0) + ' ‡πÅ‡∏ñ‡∏ß)', 'success');
            }
            updateStorageInfo();
        } catch (error) {
            console.error('Connection test error:', error);
            showStatus('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase
    async function syncFromSupabase() {
        if (!isConnected || !supabase) {
            showStatus('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Supabase', 'error');
            return;
        }
        try {
            showStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase...', 'success');
            console.log('Syncing from Supabase...');
            const { data, error } = await supabase
                .from('print_jobs')
                .select('*')
                .order('created_at', { ascending: false });
            if (error) {
                console.error('Sync error:', error);
                showStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
                return;
            }
            // Merge jobs from Supabase
            data.forEach(job => {
                savedJobsData[job.name] = {
                    name: job.name,
                    imageDataURL: job.image_data,
                    imageName: job.image_name,
                    imageSize: job.image_size || 0,
                    settings: job.settings,
                    timestamp: new Date(job.created_at).toLocaleString('th-TH'),
                    id: job.id,
                    source: 'supabase'
                };
            });
            loadSavedJobsList();
            updateStorageInfo();
            showStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (' + data.length + ' ‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Supabase)', 'success');
        } catch (error) {
            console.error('Sync error (catch):', error);
            showStatus('‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + error.message, 'error');
        }
    }
        console.log('Business Card Printer with Supabase initialized');
        console.log('Storage available:', typeof Storage !== "undefined");
        console.log('Supabase available:', typeof window.supabase !== "undefined");
        console.log('Saved jobs:', Object.keys(savedJobsData).length);
    </script>
</body>
</html>